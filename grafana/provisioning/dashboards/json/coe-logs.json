{
  "id": null,
  "uid": "coe-logs",
  "title": "CoE Logs (Loki)",
  "tags": ["coe", "loki", "logs"],
  "timezone": "",
  "schemaVersion": 39,
  "version": 4,
  "refresh": "10s",
  "time": { "from": "now-15m", "to": "now" },
  "templating": {
    "list": [
      {
        "name": "datasource",
        "type": "datasource",
        "query": "loki",
        "current": { "text": "Loki", "value": "Loki" }
      },
      {
        "name": "job",
        "label": "job",
        "type": "query",
        "datasource": { "type": "loki", "uid": "$datasource" },
        "query": "label_values({source=\"docker\"}, job)",
        "includeAll": true,
        "allValue": ".*",
        "refresh": 2,
        "current": { "text": "All", "value": ".*", "selected": true }
      },
      {
        "name": "env",
        "label": "env",
        "type": "query",
        "datasource": { "type": "loki", "uid": "$datasource" },
        "query": "label_values({source=\"docker\", job=~\"$job\"}, env)",
        "includeAll": true,
        "allValue": ".*",
        "refresh": 2,
        "current": { "text": "All", "value": ".*", "selected": true }
      },
      {
        "name": "service",
        "label": "service",
        "type": "query",
        "datasource": { "type": "loki", "uid": "$datasource" },
        "query": "label_values({source=\"docker\", job=~\"$job\", env=~\"$env\"}, service)",
        "includeAll": true,
        "allValue": ".*",
        "refresh": 2,
        "current": { "text": "All", "value": ".*", "selected": true }
      },
      {
        "name": "compose_project",
        "label": "project",
        "type": "query",
        "datasource": { "type": "loki", "uid": "$datasource" },
        "query": "label_values({source=\"docker\", job=~\"$job\", env=~\"$env\", service=~\"$service\"}, compose_project)",
        "includeAll": true,
        "allValue": ".*",
        "refresh": 2,
        "current": { "text": "All", "value": ".*", "selected": true }
      },
      {
        "name": "container",
        "label": "container",
        "type": "query",
        "datasource": { "type": "loki", "uid": "$datasource" },
        "query": "label_values({source=\"docker\", job=~\"$job\", env=~\"$env\", service=~\"$service\", compose_project=~\"$compose_project\"}, container)",
        "includeAll": true,
        "allValue": ".*",
        "refresh": 2,
        "current": { "text": "All", "value": ".*", "selected": true }
      }
    ]
  },
  "panels": [
    {
      "id": 10,
      "type": "timeseries",
      "title": "Requests per Second",
      "gridPos": { "x": 0, "y": 0, "w": 8, "h": 8 },
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": { "lineWidth": 2 }
        }
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "bottom" },
        "tooltip": { "mode": "multi", "sort": "desc" }
      },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (service)(rate({source=\"docker\", job=~\"$job\", env=~\"$env\", service=~\"$service\", compose_project=~\"$compose_project\", container=~\"$container\"}[1m]))",
          "queryType": "range",
          "legendFormat": "{{service}}"
        }
      ]
    },
    {
      "id": 11,
      "type": "timeseries",
      "title": "HTTP Status Rate",
      "gridPos": { "x": 8, "y": 0, "w": 8, "h": 8 },
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": { "lineWidth": 2 },
          "color": { "mode": "palette-classic" }
        }
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "bottom" },
        "tooltip": { "mode": "single", "sort": "desc" },
        "stacking": { "group": "A", "mode": "normal" }
      },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (status)(rate(({source=\"docker\", job=~\"$job\", env=~\"$env\", service=~\"$service\", compose_project=~\"$compose_project\", container=~\"$container\"} | pattern \"<_> - <_> [<_>] \"<_> <_> HTTP/<_>\" <status> <_> \"<_>\" \"<_>\" \"<_>\"\")[1m]))",
          "queryType": "range",
          "legendFormat": "{{status}}"
        }
      ]
    },
    {
      "id": 12,
      "type": "timeseries",
      "title": "5xx Error Rate",
      "gridPos": { "x": 16, "y": 0, "w": 8, "h": 8 },
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": { "lineWidth": 2 },
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 0.1 },
              { "color": "red", "value": 0.5 }
            ]
          }
        }
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "bottom" },
        "tooltip": { "mode": "multi", "sort": "desc" }
      },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (service)(rate(({source=\"docker\", job=~\"$job\", env=~\"$env\", service=~\"$service\", compose_project=~\"$compose_project\", container=~\"$container\"} | regexp \" 5[0-9]{2} \" )[1m]))",
          "queryType": "range",
          "legendFormat": "{{service}}"
        }
      ]
    },
    {
      "id": 13,
      "type": "bargauge",
      "title": "Top Paths (5m)",
      "gridPos": { "x": 0, "y": 8, "w": 12, "h": 8 },
      "options": { "displayMode": "gradient", "orientation": "horizontal" },
      "targets": [
        {
          "refId": "A",
          "expr": "topk(10, sum by (path)(count_over_time(({source=\"docker\", job=~\"$job\", env=~\"$env\", service=~\"$service\", compose_project=~\"$compose_project\", container=~\"$container\"} | pattern \"<_> - <_> [<_>] \"<_> <path> HTTP/<_>\" <_> <_> \"<_>\" \"<_>\" \"<_>\"\")[5m])))",
          "queryType": "instant",
          "legendFormat": "{{path}}"
        }
      ]
    },
    {
      "id": 14,
      "type": "bargauge",
      "title": "Top Containers (10m)",
      "gridPos": { "x": 12, "y": 8, "w": 12, "h": 8 },
      "options": { "displayMode": "lcd", "orientation": "horizontal" },
      "targets": [
        {
          "refId": "A",
          "expr": "topk(10, sum by (container)(count_over_time({source=\"docker\", job=~\"$job\", env=~\"$env\", service=~\"$service\", compose_project=~\"$compose_project\", container=~\"$container\"}[10m])))",
          "queryType": "instant",
          "legendFormat": "{{container}}"
        }
      ]
    },
    {
      "id": 1,
      "type": "logs",
      "title": "Live Logs",
      "gridPos": { "x": 0, "y": 16, "w": 24, "h": 12 },
      "options": {
        "dedupStrategy": "none",
        "showTime": true,
        "wrapLogMessage": true,
        "sortOrder": "Descending"
      },
      "targets": [
        {
          "refId": "A",
          "expr": "{source=\"docker\", job=~\"$job\", env=~\"$env\", service=~\"$service\", compose_project=~\"$compose_project\", container=~\"$container\"}",
          "queryType": "range"
        }
      ]
    },
    {
      "id": 15,
      "type": "logs",
      "title": "Recent 5xx Samples",
      "gridPos": { "x": 0, "y": 28, "w": 24, "h": 10 },
      "options": {
        "dedupStrategy": "none",
        "showTime": true,
        "wrapLogMessage": true,
        "sortOrder": "Descending"
      },
      "targets": [
        {
          "refId": "A",
          "expr": "{source=\"docker\", job=~\"$job\", env=~\"$env\", service=~\"$service\", compose_project=~\"$compose_project\", container=~\"$container\"} | regexp \" 5[0-9]{2} \"",
          "queryType": "range"
        }
      ]
    }
  ]
}
