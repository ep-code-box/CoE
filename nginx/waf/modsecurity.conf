###############################################################################
# ModSecurity v3 + OWASP Core Rule Set (CRS) baseline for nginx-edge
#
# Default mode: DetectionOnly (logs only). After tuning, switch to `On`.
###############################################################################

# Rule engine
SecRuleEngine DetectionOnly

# Request/response body handling
SecRequestBodyAccess On
SecRequestBodyLimit 10485760
SecRequestBodyNoFilesLimit 1048576
SecRequestBodyInMemoryLimit 131072
SecResponseBodyAccess Off

# Data dirs
SecDataDir /tmp

# Audit logging
SecAuditEngine RelevantOnly
SecAuditLog /var/log/modsecurity/audit.log
SecAuditLogFormat JSON
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial

# Debug (set to 0 in production)
SecDebugLog /var/log/modsecurity/debug.log
SecDebugLogLevel 0

# Misc hardening
SecDefaultAction "phase:1,log,pass,tag:'service:nginx-edge'"
SecAction "id:900000,phase:1,pass,log,\
  setvar:tx.allowed_methods='GET HEAD POST OPTIONS PUT DELETE',\
  setvar:tx.restricted_extensions='.ini .log .bak .old .sql',\
  setvar:tx.restricted_headers='/proxy/ /if-/',\
  setvar:tx.max_num_args=512,\
  setvar:tx.arg_name_length=1024,\
  setvar:tx.arg_length=32768,\
  setvar:tx.total_arg_length=131072,\
  setvar:tx.max_file_size=10485760,\
  setvar:tx.combined_file_sizes=10485760"

# ---------------------------------------------------------------------------
# OWASP CRS
# The CRS is included in the owasp/modsecurity-crs:nginx image under:
#   /usr/local/owasp-modsecurity-crs/
#
# If these files are present, include them; otherwise ModSecurity will skip.
# ---------------------------------------------------------------------------
Include /usr/local/owasp-modsecurity-crs/crs-setup.conf
Include /usr/local/owasp-modsecurity-crs/rules/*.conf

# Example of safe, custom early blocks (kept minimal)
# Block weird content-type on POST/PUT unless explicitly allowed by backend
SecRule REQUEST_METHOD "^(?:POST|PUT|PATCH)$" \
  "id:910020,phase:1,log,chain,deny,status:415,msg:'Suspicious content-type'"
  SecRule REQUEST_HEADERS:Content-Type "(?i)^(?:multipart\/form-data|application\/json|application\/x-www-form-urlencoded|text\/plain)(?:;|$)" "negate"
